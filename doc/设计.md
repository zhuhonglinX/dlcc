# dlcc 简单 C 语言编译器设计

## 编译器总体设计

编译器究竟完成了什么工作？如果你认真去探究编译究竟是什么意思，会发现通常人们说的编译器，其实往往是指广义的编译器，广义的编译器就是指从源代码程序输入开始，直到产生可执行程序或者直接输出结果，如下图，举例了一般编译器的工作流程。

> 一般编译器工作流程图：预处理 编译 汇编 链接

如果仔细体会编译这个过程，很容易发现编译就像是翻译。编译器就好像翻译员，他的作用在于将某种程序的源程序语言，翻译成计算机可以处理的目标语言，这个目标语言可以有很多种，比如汇编语言代码，比如二进制文件，甚至是目标机器的可执行二进制代码。

当然现实场景中，还有另一种模式的编译器，一般称为解释器，如 Python、Ruby 等，都是用了解释的技术，这些语言往往是将源代码程序转换成自身定义的虚拟指令，最终使用内置的虚拟机解释执行，直接产生结果。在这里，虚拟指令，也可以看做是一种目标语言。

这样看来，编译器所指的范围变得广义化了。dlcc 编译器希望能够结合这两者，既能产生汇编文件，也可以使用程序内置的虚拟机直接执行代码。如图:

> dlcc 工作流程图

dlcc 能够接收类 C 语言源文件（C-like source file），然后根据用户需要，产生两种不同的输出：

* 输出汇编代码，并根据用户指定的文件名，将汇编代码存储到目标文件，通常用 .s 结尾表示汇编文件。
* 产生虚拟指令，并使用内置虚拟机直接执行出结果。

## 模块设计

根据总体设计，将编译器分为以下几个模块

* 词法分析器
* 语法分析器
* 语义分析
* 代码生成器
* 抽象语法树
* 符号表和作用域模块

各模块之间工作流程如下图：

> 图：模块之间工作流程图

### 词法分析设计

词法分析（lexical analysis）模块工作示意图：

> 词法分析工作示意图

如果需要写一个程序，人们首先会在编辑器（Editor）中写下某种语言的源文件（source file），并将其保存在磁盘上。词法分析器所需要的输入就是这样的字符文件，或者说字符流（stream）。

我最终的目的是要将字符流转换为计算机可以理解的目标代码并输出，不过词法分析器不需要做那么多，他的任务是输出 Token 流。

Token 是对某种语言可识别的字符组合的代称，这个字符组可以是单个字符，也可以是多个字符组合。例如：

```c
while
abc
;
//
```

C 语言中，会存在一些关键词（Keyword），比如上述的 while 关键词，这个关键词是多个字符组成的，但是对于编译器来说，首先要做的就是将 while 看成一个整体，而不是看成五个单个的英文字母。

同理，例如 abc，根据 C 语言的语法，这应当看做一个变量的名字或者函数的名字，总而言之 abc 应当被编译器视为一个整体，而不是三个字母，通常把这类字符组合称为标识符（Identifier）。第三个例子，是单字符分号（Semicolon），即使分号是单个字符，但是根据 C 的语法，分号作为语句（Statement）的结束，也应当视作一个单独的字符组合。

以上每一个字符组合都应当视作一个单独的 Token。由此可以明确，词法分析器的任务，是将包含许多字符的字符流，解析成一个个 Token，所有的 Token 合起来，称为 Token 流。



### 语法分析设计

语法分析（Parse）的目的，是将 Token 流转换成计算机十分容易理解的形式。因此，词法分析的输入是 Token 流，输出是某种形式。通常，所谓计算机容易理解的形式或者结构，就是抽象语法树（Abstract Syntax Tree）结构。为什么语法树易于理解，可以简单举一个例子：

```c
a = b + c;
```

改写成语法树：

> 图

这种结构之所以称为易于计算机理解的结构，原因很简单，你可以使用一个通用的算法，使得这个表达式能被计算机分步骤执行，并且不产生歧义，也不会出现逻辑顺序错误，比如我可以在这里使用二叉树的后序遍历算法（Post-Order Traversal Algorithm）。这样程序会先执行`b + c`，将结果保存在`temp`中，然后向上传递，接着自然执行`a = temp`，如此就完成了整个语句，并且将 a 的值改写为 b 与 c 的和，这与我们数学课上学的的计算逻辑是一致的。

其中 temp 是一个暂时的变量（Variable），我通常使用这个符号表示这个变量只是暂时存储数据。当语句十分复杂的时候，可能需要多个 temp 临时变量来存储多个中间数据，这时候可以使用栈（Stack）这种结构来解决这个问题。这个问题不需在语法分析阶段关心，在之后的代码生成器会解决这个问题。

总之抽象语法树就是语法分析器的输出，这个也是实现语法分析器的根本目的。



### 语义分析设计

教科书的说法，语义分析（Semantic Analysis）需要去除掉抽象语法树的多余内容，并添加一些必要的信息。换一种说法，语义分析通过某种算法遍历语法分析构建的语法树，试图去理解这颗语法树究竟表达的是什么意思。包括变量究竟是不是存在，如果存在那么该变量在哪个作用域（Scope）。

例如这个语法分析树：

> 还是上面那个图

例如我此刻计算 `b + c`，首先需要判断变量 b 是否存在，这需要涉及符号表(Symbol Table)，由于最后要进行计算，因此必须明确 b 值是多少，当然语法分析不做计算，但是要知道 b 的值是多少，你必须确定这个 b 究竟是哪一个变量 b，我们都知道局部变量可以覆盖同名的全局变量。



###  符号表和作用域设计





### 代码生成器设计





## 数据结构设计

### Token 数据结构



### 语法树数据结构



### 符号表结构



### 作用域数据结构

